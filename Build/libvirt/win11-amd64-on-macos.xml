<domain type="hvf">
  <!-- Use Windows 11 Pro to enable Remote Desktop, which outperforms virtio graphics in the absence of SPICE -->
  <name>win11pro</name>
  <metadata>
    <libosinfo:libosinfo xmlns:libosinfo="http://libosinfo.org/xmlns/libvirt/domain/1.0">
      <libosinfo:os id="http://microsoft.com/win/11" />
    </libosinfo:libosinfo>
  </metadata>
  <memory>4194304</memory>
  <vcpu>4</vcpu>
  <os firmware="efi">
    <type arch="x86_64" machine="q35">hvm</type>
    <firmware>
      <!-- If Secure Boot is enabled, drivers not signed by Microsoft cannot be used -->
      <feature enabled="no" name="secure-boot" />
    </firmware>
  </os>
  <features>
    <acpi />
    <apic />
    <hyperv>
      <!-- Enabled by default -->
      <relaxed state="on" />
      <vapic state="on" />
      <spinlocks state="on" retries="8191" />
      <vpindex state="on" />
      <runtime state="on" />
      <synic state="on" />
      <stimer state="on" />
      <frequencies state="on" />
      <tlbflush state="on" />
      <ipi state="on" />
      <!-- INTEL HOSTS ONLY -->
      <evmcs state="on" />
      <avic state="on" />
      <!-- Recommended -->
      <vendor_id state="on" value="KVM Hv" />
      <reset state="on" />
      <reenlightenment state="on" />
      <emsr_bitmap state="on" />
      <xmm_input state="on" />
    </hyperv>
    <vmport state="off" />
  </features>
  <!-- On macOS, `mode="host-passthrough"` triggers blue screens of death in Windows guests -->
  <cpu mode="host-model">
    <!-- Windows Home and Pro only use 1 or 2 CPUs (sockets), so allocate vCPUs via cores and threads after checking host.cpu.topology in `virsh capabilities` output -->
    <topology sockets="1" cores="4" threads="1" />
  </cpu>
  <clock offset="variable" basis="localtime">
    <timer name="rtc" tickpolicy="catchup" />
    <timer name="pit" tickpolicy="delay" />
    <timer name="hpet" present="no" />
    <timer name="hypervclock" present="yes" />
  </clock>
  <!-- Uncomment to allow changes during setup -->
  <!--<on_reboot>destroy</on_reboot>-->
  <pm>
    <suspend-to-mem enabled="no" />
    <suspend-to-disk enabled="no" />
  </pm>
  <devices>
    <emulator>/usr/local/bin/qemu-system-x86_64</emulator>
    <disk type="file" device="disk">
      <driver name="qemu" type="qcow2" cache="none" discard="unmap" />
      <source file="/path/to/win11pro.qcow2" />
      <!-- Replace with `sata` during installation if detection fails -->
      <target dev="vda" bus="virtio" />
      <boot order="1" />
    </disk>
    <!-- Option 1: provide custom install media -->
    <disk type="file" device="disk">
      <driver name="qemu" type="qcow2" />
      <source file="/path/to/win11-amd64-disk-image.qcow2" />
      <!-- Replace with `usb` during installation if `viostor` detection fails -->
      <target dev="vdb" bus="virtio" />
      <readonly />
      <boot order="2" />
    </disk>
    <!-- Option 2: provide a standard ISO file (use `sata` during installation if `vioscsi` detection fails) -->
    <!--
    <disk type="file" device="cdrom">
      <driver name="qemu" type="raw" />
      <source file="/path/to/Win11_24H2_EnglishInternational_x64.iso" />
      <target dev="sda" bus="scsi" />
      <readonly />
    </disk>
    -->
    <disk type="file" device="disk">
      <driver name="qemu" type="qcow2" cache="none" discard="unmap" />
      <!--
      Provide `win10-unattended` media with:

      - `viostor` and `vioscsi` drivers in the boot-critical `Drivers` directory
      - other `virtio-win` drivers in the `Drivers2` directory
      -->
      <source file="/path/to/win11pro-1.qcow2" />
      <target dev="sdb" bus="usb" removable="on" />
    </disk>
    <controller type="usb" model="qemu-xhci" />
    <controller type="scsi" model="virtio-scsi" />
    <controller type="pci" model="pcie-root" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <console type="pty" />
    <channel type="unix">
      <source mode="bind" />
      <target type="virtio" name="org.qemu.guest_agent.0" />
    </channel>
    <input type="tablet" bus="usb" />
    <input type="keyboard" bus="usb" />
    <input type="tablet" bus="virtio" />
    <input type="keyboard" bus="virtio" />
    <tpm>
      <backend type="emulator" version="2.0" />
    </tpm>
    <rng model="virtio">
      <backend model="random">/dev/urandom</backend>
    </rng>
    <graphics type="vnc" port="-1" />
    <video>
      <model type="bochs" />
    </video>
  </devices>
  <!-- Option 1: qemu:///session with usermode networking (until QEMU has the `com.apple.vm.networking` entitlement) -->
  <qemu:commandline xmlns:qemu="http://libvirt.org/schemas/domain/qemu/1.0">
    <qemu:arg value="-netdev" />
    <qemu:arg value="user,id=ua-net0,hostfwd=tcp::3389-:3389,hostfwd=udp::3389-:3389" />
    <qemu:arg value="-device" />
    <qemu:arg value="virtio-net,netdev=ua-net0,mac={{GUEST_MAC}},addr=10.0" />
  </qemu:commandline>
  <!-- Option 2: qemu:///system with bridged networking -->
  <!--
  <qemu:commandline xmlns:qemu="http://libvirt.org/schemas/domain/qemu/1.0">
    <qemu:arg value="-netdev" />
    <qemu:arg value="vmnet-bridged,id=ua-en0,ifname=en0" />
    <qemu:arg value="-device" />
    <qemu:arg value="virtio-net,netdev=ua-en0,mac={{GUEST_MAC}},addr=10.0" />
  </qemu:commandline>
  -->
</domain>