<domain type="kvm">
  <name>win11</name>
  <metadata>
    <libosinfo:libosinfo xmlns:libosinfo="http://libosinfo.org/xmlns/libvirt/domain/1.0">
      <libosinfo:os id="http://microsoft.com/win/11" />
    </libosinfo:libosinfo>
  </metadata>
  <memory>4194304</memory>
  <vcpu>4</vcpu>
  <os firmware="efi">
    <type arch="x86_64" machine="q35">hvm</type>
    <firmware>
      <!-- If Secure Boot is enabled, drivers not signed by Microsoft cannot be used -->
      <feature enabled="no" name="secure-boot" />
    </firmware>
  </os>
  <features>
    <acpi />
    <apic />
    <hyperv>
      <!-- Enabled by default -->
      <relaxed state="on" />
      <vapic state="on" />
      <spinlocks state="on" retries="8191" />
      <vpindex state="on" />
      <runtime state="on" />
      <synic state="on" />
      <stimer state="on" />
      <frequencies state="on" />
      <tlbflush state="on" />
      <ipi state="on" />
      <!-- INTEL HOSTS ONLY -->
      <evmcs state="on" />
      <!-- May slow down guests on old hardware (without APICv/AVIC support) -->
      <avic state="on" />
      <!-- Recommended -->
      <vendor_id state="on" value="KVM Hv" />
      <reset state="on" />
      <reenlightenment state="on" />
      <emsr_bitmap state="on" />
      <xmm_input state="on" />
    </hyperv>
    <vmport state="off" />
    <ps2 state="off" />
  </features>
  <cpu mode="host-passthrough">
    <!-- Windows Home and Pro only use 1 or 2 CPUs (sockets), so allocate vCPUs via cores and threads after checking host.cpu.topology in `virsh capabilities` output -->
    <topology sockets="1" cores="2" threads="2" />
  </cpu>
  <clock offset="variable" basis="localtime">
    <timer name="rtc" tickpolicy="catchup" />
    <timer name="pit" tickpolicy="delay" />
    <timer name="hpet" present="no" />
    <timer name="hypervclock" present="yes" />
  </clock>
  <pm>
    <suspend-to-mem enabled="no" />
    <suspend-to-disk enabled="no" />
  </pm>
  <devices>
    <emulator>/usr/bin/qemu-system-x86_64</emulator>
    <disk type="file" device="disk">
      <driver name="qemu" type="qcow2" cache="none" discard="unmap" />
      <source file="/path/to/win11.qcow2" />
      <!-- Replace with `sata` during installation if detection fails -->
      <target dev="vda" bus="virtio" />
      <boot order="1" />
      <alias name="ua-system-disk" />
    </disk>
    <!-- Option 1: provide custom install media -->
    <disk type="file" device="disk">
      <driver name="qemu" type="qcow2" />
      <source file="/path/to/win11-amd64-disk-image.qcow2" />
      <!-- Replace with `usb` during installation if `viostor` detection fails -->
      <target dev="vdb" bus="virtio" />
      <readonly />
      <boot order="2" />
    </disk>
    <!-- Option 2: provide a standard ISO file (use `sata` during installation if `vioscsi` detection fails) -->
    <!--
    <disk type="file" device="cdrom">
      <driver name="qemu" type="raw" />
      <source file="/path/to/Win11_24H2_EnglishInternational_x64.iso" />
      <target dev="sda" bus="scsi" />
      <readonly />
    </disk>
    -->
    <disk type="file" device="disk">
      <driver name="qemu" type="qcow2" cache="none" discard="unmap" />
      <!--
      Provide `win10-unattended` media with:

      - `viostor` and `vioscsi` drivers in the boot-critical `Drivers` directory
      - other `virtio-win` drivers in the `Drivers2` directory
      -->
      <source file="/path/to/win11-1.qcow2" />
      <target dev="sdb" bus="usb" removable="on" />
    </disk>
    <controller type="usb" model="qemu-xhci" />
    <controller type="scsi" model="virtio-scsi" />
    <controller type="pci" model="pcie-root" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <controller type="pci" model="pcie-root-port" />
    <interface type="network">
      <source network="default" />
      <model type="virtio" />
    </interface>
    <console type="pty" />
    <channel type="spicevmc">
      <target type="virtio" name="com.redhat.spice.0" />
    </channel>
    <channel type="unix">
      <source mode="bind" />
      <target type="virtio" name="org.qemu.guest_agent.0" />
    </channel>
    <input type="tablet" bus="usb" />
    <input type="keyboard" bus="usb" />
    <input type="tablet" bus="virtio" />
    <input type="keyboard" bus="virtio" />
    <graphics type="spice" port="-1" tlsPort="-1" autoport="yes">
      <image compression="off" />
    </graphics>
    <sound model="ich9" />
    <video>
      <model type="qxl" />
    </video>
    <redirdev bus="usb" type="spicevmc" />
    <redirdev bus="usb" type="spicevmc" />
    <!-- Only allow mass storage devices to be redirected -->
    <redirfilter>
      <usbdev class="0x08" allow="yes" />
      <usbdev allow="no" />
    </redirfilter>
    <tpm>
      <backend type="emulator" version="2.0" />
    </tpm>
    <rng model="virtio">
      <backend model="random">/dev/urandom</backend>
    </rng>
  </devices>
  <qemu:override xmlns:qemu="http://libvirt.org/schemas/domain/qemu/1.0">
    <qemu:device alias="ua-system-disk">
      <qemu:frontend>
        <!-- Improve Windows defrag/TRIM performance -->
        <qemu:property name="discard_granularity" type="unsigned" value="33554432" />
      </qemu:frontend>
    </qemu:device>
  </qemu:override>
</domain>